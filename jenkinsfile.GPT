pipeline {
    agent any   // Виконується на будь-якому доступному агенті Jenkins

    stages {
        stage('Install Apache') {
            steps {
                script {
                    sh '''
                        #!/bin/bash
                        set -e  #зупиняємо виконання, якщо якась команда впаде

                        echo "Оновлюємо список пакетів..."
                        apt-get update -y

                        echo "Встановлюємо Apache..."
                        apt-get install -y apache2

                        echo "Запускаємо і додаємо Apache в автозапуск..."
                        systemctl start apache2 || true   #true дозволяє уникнути падіння, якщо сервіс вже запущений
                        systemctl enable apache2 || true

                        echo "Перевіряємо, чи активний Apache..."
                        systemctl is-active --quiet apache2
                    '''
                }
            }
        }

        stage('Verify Apache Running') {
            steps {
                script {
                    sh '''
                        echo "Тестуємо, чи Apache віддає головну сторінку..."
                        # Викликаємо curl і шукаємо у відповіді "200 OK"
                        curl -I http://localhost | grep "200 OK" || {
                          echo "[ERROR] Apache не віддає 200 OK!"
                          exit 1
                        }
                    '''
                }
            }
        }

        stage('Trigger 404') {
            steps {
                script {
                    sh '''
                        echo "Викликаємо неіснуючу сторінку для перевірки 404..."
                        # Зберігаємо код відповіді у змінну
                        STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost/missing-folder/assistent.html)

                        # Очікуємо саме 404
                        if [ "$STATUS" -ne 404 ]; then
                          echo "[ERROR] Очікувався 404, але отримали $STATUS"
                          exit 1
                        else
                          echo "Правильно отримали 404 відповідь"
                        fi
                    '''
                }
            }
        }
    }

    post {
        always {
            echo "Pipeline завершено (незалежно від результату)."
        }
        success {
            echo "Apache встановлено і перевірено успішно."
        }
        failure {
            echo "Pipeline впав. Перевірте логи вище."
        }
    }
}
